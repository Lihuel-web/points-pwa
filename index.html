<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Points Control</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#f4f7ff; color:#123; }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#eaf1ff; border-bottom:1px solid #d6e2ff; }
    header h1 { margin:0; color:#1959b7; font-size:22px; }
    header .brand { color:#7a8da8; }
    main { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .muted { color:#667892 }
    .tag { font-size: 12px; padding: 2px 8px; border:1px solid #cdd8ee; border-radius: 999px; background:#f6f9ff; color:#1959b7 }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #cdd8ee; background:white; cursor:pointer; color:#123; }
    button.primary { background:#1959b7; color:#fff; border-color:#1959b7 }
    button.danger { background:#fff; color:#b00020; border-color:#ffd0d4; }
    input, select, textarea { padding: 8px; border-radius: 8px; border: 1px solid #cdd8ee; background:white; color:#123; caret-color:#123; }
    input::placeholder { color:#7a8da8; opacity:1; }
    .card { background:white; border:1px solid #e2e8f6; border-radius: 12px; padding:16px; margin:14px 0 }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    @media (max-width: 980px){ .grid-2 { grid-template-columns: 1fr; } }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eef3ff; padding: 8px 6px; text-align: left; }
    thead th { background:#f2f6ff; color:#1959b7 }
    #teacher-panel, #student-panel, #authed { display:none }
    .scroll-300 { max-height:300px; overflow:auto }
    .scroll-450 { max-height:450px; overflow:auto }
    .section-title { margin:8px 0 12px; color:#1959b7 }
    .hint { font-size:12px; color:#7a8da8 }
    .hl { background:#fff8d6; }
    .swatch { display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:6px; border:1px solid rgba(0,0,0,.06); vertical-align: -1px; }
    .legend-item { margin-right:12px; }
  </style>
</head>
<body>
  <header>
    <h1>Points Control</h1>
    <div class="brand">Westhill</div>
  </header>

  <main>
    <!-- LOGIN -->
    <section id="auth" class="card">
      <h3 class="section-title">Login</h3>
      <form id="login-form" class="row">
        <input id="email" type="email" placeholder="Email" required autocomplete="username" />
        <input id="password" type="password" placeholder="Contraseña" required autocomplete="current-password" />
        <button type="submit" class="primary">Enter</button>
      </form>
      <p class="muted">El registro está deshabilitado. Pide tu cuenta al profesor.</p>
    </section>

    <!-- APP AUTENTICADA -->
    <section id="authed">
      <div class="row card">
        <div id="whoami" class="muted"></div>
        <span id="role-badge" class="tag"></span>
        <button id="logout">Logout</button>
        <button id="change-pass">Change password</button>
      </div>

      <!-- TEACHER -->
      <section id="teacher-panel">
        <div class="grid-2">
          <!-- Latest tx -->
          <div class="card">
            <h3 class="section-title">Latest transactions</h3>
            <div class="scroll-300">
              <table id="tx-table">
                <thead><tr><th>Fecha</th><th>Alumno</th><th>Δ</th><th>Motivo</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Teams overview -->
          <div class="card">
            <h3 class="section-title">Teams overview</h3>
            <div class="grid-2">
              <div>
                <div class="hint" style="margin-bottom:6px">Global pools (clic para ver locales)</div>
                <div class="scroll-300">
                  <table id="pool-table">
                    <thead><tr><th>Global team</th><th>Points</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div>
                <div class="hint" id="local-title" style="margin-bottom:6px">—</div>
                <div class="scroll-300">
                  <table id="local-table">
                    <thead><tr><th>Local team</th><th>Spent</th><th>Remaining (local)</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ajuste manual -->
        <div class="card">
          <h3 class="section-title">Manual adjust</h3>
          <form id="adjust-form" class="row">
            <select id="adjust-scope">
              <option value="pool">Global pool</option>
              <option value="local">Local team (spend)</option>
            </select>
            <select id="adjust-pool-id" title="Global team"></select>
            <select id="adjust-local-id" title="Local team (auto relleno por pool)"></select>
            <input id="adjust-delta" type="number" step="1" value="1" />
            <input id="adjust-reason" placeholder="Reason (optional)" />
            <button type="submit" class="primary">Apply</button>
          </form>
          <div class="hint">Usa valores negativos para restar (gasto) si corresponde.</div>
        </div>

        <!-- Gestión de equipos + membresías -->
        <div class="card">
          <h3 class="section-title">Teams management</h3>
          <div class="grid-2">
            <div>
              <form id="new-team-form" class="row">
                <input id="team-name" placeholder="Team name (e.g., Team 1)" required />
                <input id="team-class" placeholder="Class/Group (e.g., 8A)" />
                <button type="submit">Create team</button>
              </form>

              <div class="row" style="margin-top:8px">
                <select id="team-select" title="Team"></select>
                <button id="reload-teams" type="button">Reload</button>
                <button id="delete-team" type="button">Delete team</button>
              </div>

              <div class="row" style="margin-top:8px">
                <select id="student-pool" title="Student"></select>
                <button id="assign-member" type="button">Assign to team</button>
                <button id="remove-member" type="button">Remove from team</button>
              </div>

              <div style="margin-top:8px">
                <strong>Team members</strong>
                <ul id="team-members"></ul>
              </div>

              <div style="margin-top:8px">
                <strong>Team balance:</strong> <span id="team-balance">—</span> pts
              </div>
            </div>

            <!-- Link card -->
            <div>
              <h4 style="margin:0 0 8px">Link card</h4>
              <div class="row">
                <select id="link-card-role">
                  <option value="student">Student card</option>
                  <option value="team_earn">Team (global/local) earn card</option>
                </select>
                <input id="link-card-uid" placeholder="Scan or type UID" />
              </div>
              <div class="row" style="margin-top:8px">
                <select id="link-card-student" title="Student"></select>
                <select id="link-card-team" title="Team"></select>
                <button id="link-card-btn" class="primary">Save link</button>
              </div>
              <div class="hint">Los UID se normalizan a HEX mayúsculas sin separadores automáticamente.</div>
            </div>
          </div>
        </div>

        <!-- Local leaderboard (por pool) -->
        <div class="card">
          <h3 class="section-title">Local leaderboard</h3>
          <div class="row">
            <select id="leaderboard-pool" title="Global team"></select>
            <button id="refresh-leaderboard" type="button">Reload</button>
          </div>
          <div class="scroll-300" style="margin-top:8px">
            <table id="leaderboard-table">
              <thead><tr><th>#</th><th>Local team</th><th>Spent</th><th>Total (local)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Ordenado por <em>Total (local) = pool − spent</em>, de mayor a menor.</div>
        </div>

        <!-- All locals leaderboard -->
        <div class="card">
          <h3 class="section-title">All locals leaderboard</h3>
          <div class="row">
            <label><input type="checkbox" id="alllb-filter-toggle" /> Filter by global</label>
            <select id="alllb-pool" title="Global team" disabled></select>
            <button id="alllb-refresh" type="button">Reload</button>
          </div>
          <div class="muted" id="alllb-legend" style="margin-top:8px"></div>
          <div class="scroll-300" style="margin-top:8px">
            <table id="alllb-table">
              <thead><tr><th>#</th><th>Local team</th><th>Global</th><th>Spent</th><th>Total (local)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Tabla global de todos los equipos locales. Sombreado por color según el pool.</div>
        </div>

        <!-- STUDENTS MANAGEMENT -->
        <div id="students-mgmt" class="card">
          <h3 class="section-title">Students</h3>
          <div class="grid-2">
            <!-- Real (Auth) -->
            <div>
              <h4 style="margin:0 0 8px">Create real student (Auth)</h4>
              <form id="real-student-form" class="row">
                <input id="real-name" placeholder="Name (optional)" />
                <input id="real-class" placeholder="Class/Group" />
                <input id="real-email" type="email" placeholder="Email" required />
                <input id="real-pass" type="password" placeholder="Temp password (min 6)" required />
                <input id="real-card-uid" placeholder="Card UID (optional)" />
                <select id="real-pool-team" title="Global team (optional)"></select>
                <select id="real-local-team" title="Local team (optional)"></select>
                <button type="submit" class="primary">Create</button>
              </form>
              <div class="hint">Puedes elegir primero el <strong>local</strong> y se ajusta el global automáticamente.</div>
            </div>

            <!-- Record-only -->
            <div>
              <h4 style="margin:0 0 8px">Add record-only student</h4>
              <form id="fake-student-form" class="row">
                <input id="fake-name" placeholder="Name" required />
                <input id="fake-class" placeholder="Class/Group" />
                <input id="fake-card-uid" placeholder="Card UID (optional)" />
                <select id="fake-pool-team" title="Global team (optional)"></select>
                <select id="fake-local-team" title="Local team (optional)"></select>
                <button type="submit">Add</button>
              </form>
              <div class="hint">Puedes elegir primero el <strong>local</strong> y se ajusta el global automáticamente.</div>
            </div>
          </div>

          <!-- Danger zone: Delete student -->
          <div style="margin-top:12px">
            <h4 style="margin:0 0 8px">Delete student</h4>
            <div class="row">
              <select id="delete-student-select" title="Student to delete"></select>
              <button id="delete-student-btn" class="danger">Delete</button>
            </div>
            <div class="hint">Elimina al alumno, su usuario (si existe), y limpia membresías/tx (CASCADE/Edge).</div>
          </div>
        </div>
      </section> <!-- /#teacher-panel -->

      <!-- STUDENT -->
      <section id="student-panel" class="card">
        <h3 class="section-title">My points</h3>
        <div id="student-info" class="muted"></div>
        <h4>My balance: <span id="balance">—</span> points</h4>

        <div style="margin-top:10px">
          <strong>My last movements</strong>
          <div class="scroll-300">
            <table id="mytx-table">
              <thead><tr><th>Date</th><th>Δ</th><th>Reason</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3 class="section-title">My team</h3>
          <div id="team-info" class="muted"></div>
          <h4>Team balance: <span id="my-team-balance">—</span> points</h4>
          <div class="scroll-300">
            <strong>Team members</strong>
            <ul id="my-team-members"></ul>
          </div>
        </div>

        <!-- Overview del Pool Global del alumno -->
        <div style="margin-top:16px">
          <h3 class="section-title">Global team (pool) overview</h3>
          <div class="muted" id="pool-meta">—</div>
          <div class="row">
            <div><strong>Pool total:</strong> <span id="pool-total">—</span> pts</div>
            <div style="margin-left:12px"><strong>Remaining (overall):</strong> <span id="pool-remaining-global">—</span> pts</div>
          </div>

          <div class="row" style="margin-top:8px">
            <div><strong>My local spent:</strong> <span id="my-local-spent">—</span> pts</div>
            <div style="margin-left:12px"><strong>My local total (remaining):</strong> <span id="my-local-remaining">—</span> pts</div>
          </div>

          <div class="scroll-300" style="margin-top:8px">
            <table>
              <thead><tr><th>Local team</th><th>Spent</th><th>Remaining for this local</th></tr></thead>
              <tbody id="pool-locals-tbody"></tbody>
            </table>
          </div>
          <div class="hint">La fila resaltada corresponde a tu equipo local.</div>
        </div>

        <!-- Global teams leaderboard (estudiante) -->
        <div style="margin-top:16px">
          <h3 class="section-title">Global teams leaderboard</h3>
          <div class="scroll-300">
            <table id="student-global-leaderboard">
              <thead><tr><th>#</th><th>Global team</th><th>Points</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Ranking por puntos del pool global.</div>
        </div>

        <!-- NUEVO: Top 9 local teams (estudiante) -->
        <div style="margin-top:16px">
          <h3 class="section-title">Top 9 local teams</h3>
          <div class="scroll-300">
            <table id="student-local-top9">
              <thead><tr><th>#</th><th>Local team</th><th>Global</th><th>Spent</th><th>Total (local)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Se muestran sólo los 9 mejores equipos locales por <em>Total (local) = pool − spent</em>.</div>
        </div>

      </section>
    </section>
  </main>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- Config pública -->
  <script>
    window.SUPABASE_URL = "https://rmhwafuymxcicxaructc.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtaHdhZnV5bXhjaWN4YXJ1Y3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MzAxNDcsImV4cCI6MjA3MTIwNjE0N30.u3p-n0mwER9jXvfefuG8VASFPa6TKUlCaYVbp4TW9-w";
  </script>
  <script src="./app.js"></script>
</body>
</html>
