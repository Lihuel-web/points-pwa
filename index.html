<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Points Control</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header class="appbar">
    <div class="brand">Points Control</div>
    <div class="spacer"></div>
    <div id="whoami" class="muted"></div>
    <span id="role-badge" class="badge"></span>
    <button id="logout" class="btn ghost">Logout</button>
    <button id="change-pass" class="btn ghost">Change password</button>
  </header>

  <!-- LOGIN -->
  <section id="auth" class="shell">
    <div class="card">
      <h2>Login</h2>
      <form id="login-form" class="row">
        <input id="email" type="email" placeholder="Email" required autocomplete="username">
        <input id="password" type="password" placeholder="Contraseña" required autocomplete="current-password">
        <button class="btn primary" type="submit">Enter</button>
      </form>
      <p class="muted">El registro está deshabilitado. Pide tu cuenta al profesor.</p>
    </div>
  </section>

  <!-- APP -->
  <section id="authed" class="shell" style="display:none">

    <!-- TEACHER PANEL -->
    <section id="teacher-panel" style="display:none">

      <div class="grid two">
        <!-- Teams overview -->
        <div class="card">
          <div class="row space-between">
            <h3>Teams overview</h3>
            <a class="muted" id="refresh-overview" href="#">Reload</a>
          </div>

          <h4>Global pools</h4>
          <table class="tbl">
            <thead><tr><th>Global team</th><th class="right">Points</th></tr></thead>
            <tbody id="tbl-global-pools"><tr><td colspan="2">—</td></tr></tbody>
          </table>

          <h4 class="mt">Local summary <span class="muted">(selected global)</span></h4>
          <div class="muted">Global: <strong id="local-summary-title">—</strong></div>
          <table class="tbl">
            <thead><tr><th>Local team</th><th class="right">Spent</th><th class="right">Pool remaining</th></tr></thead>
            <tbody id="tbl-local-summary"><tr><td colspan="3">—</td></tr></tbody>
          </table>
        </div>

        <!-- Latest tx -->
        <div class="card">
          <h3>Latest transactions</h3>
          <div class="scroll" style="max-height:420px">
            <table class="tbl">
              <thead><tr><th>Date</th><th>Student</th><th>Δ</th><th>Reason</th></tr></thead>
              <tbody id="tx-table"><tr><td colspan="4">—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- NUEVO: crear cuenta de alumno -->
      <div class="card">
        <h3>Create student account (email + password)</h3>
        <form id="create-student-account" class="row wrap">
          <input id="ct-name"  placeholder="Full name" required>
          <input id="ct-class" placeholder="Class (e.g., 8A)">
          <input id="ct-email" type="email" placeholder="Email" required>
          <input id="ct-pass"  type="password" placeholder="Password (≥6)" required>
          <button class="btn primary" type="submit">Create account</button>
        </form>
        <p class="muted">Crea Auth user + profile(student) + students (via Edge Function).</p>
      </div>

      <!-- NUEVO: alta rápida sin cuenta -->
      <div class="card">
        <h3>Add student (record-only)</h3>
        <form id="new-student-form" class="row wrap">
          <input id="ns-name"  placeholder="Full name" required>
          <input id="ns-class" placeholder="Class (e.g., 8A)">
          <input id="ns-card"  placeholder="Card UID (optional)">
          <button id="ns-create-btn" class="btn" type="submit">Create</button>
        </form>
      </div>

      <!-- Asignación a equipos (global → locales) -->
      <div class="card">
        <h3>Team membership</h3>
        <div class="row wrap">
          <label>Global
            <select id="sel-global"></select>
          </label>
          <label>Local (of selected global)
            <select id="sel-local"></select>
          </label>
          <label>Student
            <select id="student-pool"></select>
          </label>
          <button id="assign-member" class="btn">Assign to local</button>
          <button id="remove-member" class="btn ghost">Remove from local</button>
        </div>
        <div class="mt">
          <strong>Members</strong>
          <ul id="team-members"></ul>
        </div>
      </div>
    </section>

    <!-- STUDENT PANEL -->
    <section id="student-panel" style="display:none">
      <div class="card">
        <h3>My points</h3>
        <div id="student-info" class="muted"></div>
        <div class="grid three mt">
          <div class="stat"><div class="k">Global team</div><div id="st-global-name" class="v">—</div></div>
          <div class="stat"><div class="k">Pool points</div><div id="st-global-points" class="v">—</div></div>
          <div class="stat"><div class="k">Local team</div><div id="st-local-name" class="v">—</div></div>
          <div class="stat"><div class="k">Spent (local)</div><div id="st-local-spent" class="v">—</div></div>
          <div class="stat"><div class="k">Remaining</div><div id="st-local-rem" class="v">—</div></div>
        </div>

        <h4 class="mt">My last movements</h4>
        <div class="scroll" style="max-height:320px">
          <table class="tbl">
            <thead><tr><th>Date</th><th>Δ</th><th>Reason</th></tr></thead>
            <tbody id="mytx-body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </section>

  <!-- Supabase SDK UMD -->
  <script>
    window.SUPABASE_URL = "https://rmhwafuymxcicxaructc.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtaHdhZnV5bXhjaWN4YXJ1Y3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MzAxNDcsImV4cCI6MjA3MTIwNjE0N30.u3p-n0mwER9jXvfefuG8VASFPa6TKUlCaYVbp4TW9-w";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="./app.js"></script>
</body>
</html>
