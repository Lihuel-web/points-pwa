<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%230b1120'/%3E%3Ctext x='14' y='46' font-size='38' fill='%2393c5fd'%3EA%3C/text%3E%3C/svg%3E">
  <title>Points Control</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: "Space Grotesk", "Inter", system-ui, -apple-system, sans-serif; margin: 0; background:#f4f7ff; color:#0f172a; transition: background 0.3s ease, color 0.3s ease; }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#eaf1ff; border-bottom:1px solid #d6e2ff; }
    header h1 { margin:0; color:#1959b7; font-size:22px; letter-spacing:0.3px; }
    header .brand { color:#7a8da8; }
    main { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .muted { color:#667892 }
    .tag { font-size: 12px; padding: 2px 8px; border:1px solid #cdd8ee; border-radius: 999px; background:#f6f9ff; color:#1959b7 }
    button { padding: 8px 12px; border-radius: 10px; border: 1px solid #cdd8ee; background:white; cursor:pointer; color:#0f172a; transition: transform 0.12s ease, box-shadow 0.2s ease, background 0.2s ease; }
    button.primary { background:#1959b7; color:#fff; border-color:#1959b7 }
    button.danger { background:#fff; color:#b00020; border-color:#ffd0d4; }
    button:hover { transform: translateY(-1px); }
    input, select, textarea { padding: 8px; border-radius: 10px; border: 1px solid #cdd8ee; background:white; color:#0f172a; caret-color:#0f172a; }
    input::placeholder { color:#7a8da8; opacity:1; }
    .card { background:white; border:1px solid #e2e8f6; border-radius: 16px; padding:16px; margin:14px 0; box-shadow:0 12px 30px rgba(17, 24, 39, 0.06); }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    @media (max-width: 980px){ .grid-2 { grid-template-columns: 1fr; } }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eef3ff; padding: 8px 6px; text-align: left; }
    thead th { background:#f2f6ff; color:#1959b7 }
    #teacher-panel, #student-panel, #authed { display:none }
    .scroll-300 { max-height:300px; overflow:auto }
    .scroll-450 { max-height:450px; overflow:auto }
    .section-title { margin:8px 0 12px; color:#1959b7 }
    .hint { font-size:12px; color:#7a8da8 }
    .hl { background:#fff8d6; }
    .swatch { display:inline-block; width:12px; height:12px; border-radius:3px; margin-right:6px; border:1px solid rgba(0,0,0,.06); vertical-align: -1px; }
    .legend-item { margin-right:12px; }
    .ghost { background:transparent; border-color:#cdd8ee; color:#1959b7; }

    /* Cyberpunk neon theme */
    body.theme-cyber {
      background: radial-gradient(120% 120% at 10% 20%, rgba(120,0,255,0.25), transparent 50%), radial-gradient(120% 120% at 80% 0%, rgba(0,255,200,0.22), transparent 45%), #060814;
      color:#e8f2ff;
      text-shadow: 0 0 10px rgba(0,255,255,0.1);
    }
    body.theme-cyber header {
      background: linear-gradient(90deg, rgba(10,15,40,0.85), rgba(12,20,60,0.75));
      border-bottom:1px solid rgba(0,255,200,0.25);
      box-shadow: 0 10px 40px rgba(0,255,200,0.08);
    }
    body.theme-cyber header h1 { color:#7cf4ff; text-shadow:0 0 12px rgba(124,244,255,0.5); }
    body.theme-cyber header .brand { color:#8ea8ff; }
    body.theme-cyber button {
      background: rgba(12,18,38,0.85);
      color:#e8f2ff;
      border-color: rgba(124,244,255,0.25);
      box-shadow: 0 0 12px rgba(124,244,255,0.15);
    }
    body.theme-cyber button.primary {
      background: linear-gradient(135deg, #7c3aed, #0ea5e9);
      border-color: rgba(126,34,206,0.6);
      box-shadow: 0 0 18px rgba(14,165,233,0.5);
      color:#f8fbff;
    }
    body.theme-cyber button.danger {
      background: rgba(44,14,32,0.8);
      border-color: rgba(255,83,143,0.45);
      color:#ff85b5;
      box-shadow: 0 0 16px rgba(255,83,143,0.4);
    }
    body.theme-cyber button.ghost {
      border-color: rgba(124,244,255,0.35);
      color:#7cf4ff;
    }
    body.theme-cyber input,
    body.theme-cyber select,
    body.theme-cyber textarea {
      background: rgba(10,14,30,0.85);
      color:#e8f2ff;
      border:1px solid rgba(124,244,255,0.35);
      box-shadow: inset 0 0 10px rgba(14,165,233,0.15);
    }
    body.theme-cyber input::placeholder { color:#8fa6ff; opacity:1; }
    body.theme-cyber .card {
      background: linear-gradient(145deg, rgba(10,12,30,0.92), rgba(14,20,50,0.9));
      border:1px solid rgba(124,244,255,0.18);
      box-shadow: 0 18px 44px rgba(10,10,30,0.45), 0 0 20px rgba(126,34,206,0.25);
    }
    body.theme-cyber .tag {
      background: rgba(124,244,255,0.12);
      border-color: rgba(124,244,255,0.4);
      color:#7cf4ff;
      text-shadow: 0 0 8px rgba(124,244,255,0.45);
    }
    body.theme-cyber .muted,
    body.theme-cyber .hint { color:#9cb7ff; }
    body.theme-cyber table { color:#e8f2ff; }
    body.theme-cyber thead th {
      background: rgba(124,244,255,0.08);
      color:#9cf3ff;
      border-bottom:1px solid rgba(124,244,255,0.25);
      text-shadow: 0 0 8px rgba(124,244,255,0.35);
    }
    body.theme-cyber th, body.theme-cyber td { border-bottom: 1px solid rgba(124,244,255,0.18); }
    body.theme-cyber table tbody td { color:#e8f5ff; text-shadow:0 0 6px rgba(0,255,255,0.25); font-weight:600; }
    body.theme-cyber table tbody tr { backdrop-filter: saturate(1.05); }
    body.theme-cyber #alllb-table tbody td { color:#0b111a; text-shadow:none; font-weight:700; }
    body.theme-cyber .legend-item { color:#cfe8ff; }
    body.theme-cyber .scroll-300 {
      background: rgba(8,10,24,0.85);
      border:1px solid rgba(124,244,255,0.18);
      box-shadow: inset 0 0 12px rgba(14,165,233,0.12);
    }
  </style>
</head>
  <body>
    <header>
      <h1>Points Control</h1>
      <div class="brand">Westhill</div>
      <button id="theme-toggle" class="ghost">Neon mode</button>
    </header>

  <main>
    <!-- LOGIN -->
    <section id="auth" class="card">
      <h3 class="section-title">Login</h3>
      <form id="login-form" class="row">
        <input id="email" type="email" placeholder="Email" required autocomplete="username" />
        <input id="password" type="password" placeholder="Password" required autocomplete="current-password" />
        <button type="submit" class="primary">Enter</button>
      </form>
      <p class="muted">Sign-up is disabled. Ask your teacher for an account.</p>
    </section>

    <!-- APP AUTENTICADA -->
    <section id="authed">
      <div class="row card">
        <div id="whoami" class="muted"></div>
        <span id="role-badge" class="tag"></span>
        <button id="logout">Logout</button>
        <button id="change-pass">Change password</button>
      </div>

      <!-- TEACHER -->
      <section id="teacher-panel">
        <div class="card">
          <div class="row">
            <div class="muted">Vista previa del alumno (abre en nueva pestaña)</div>
            <button id="student-preview-btn" type="button">Abrir panel de estudiante genérico</button>
          </div>
          <div class="hint">Usa esta vista para comprobar qué ve un alumno promedio sin cerrar sesión como profesor.</div>
        </div>
        <div class="grid-2">
          <!-- Latest tx -->
          <div class="card">
            <h3 class="section-title">Latest transactions</h3>
            <div class="scroll-300">
              <table id="tx-table">
                <thead><tr><th>Date</th><th>Student</th><th>Δ</th><th>Reason</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Teams overview -->
          <div class="card">
            <h3 class="section-title">Teams overview</h3>
            <div class="grid-2">
              <div>
                <div class="hint" style="margin-bottom:6px">Global pools (clic para ver locales)</div>
                <div class="scroll-300">
                  <table id="pool-table">
                    <thead><tr><th>Global team</th><th>Points</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div>
                <div class="hint" id="local-title" style="margin-bottom:6px">—</div>
                <div class="scroll-300">
                  <table id="local-table">
                    <thead><tr><th>Local team</th><th>Spent</th><th>Remaining (local)</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ajuste manual -->
        <div class="card">
          <h3 class="section-title">Manual adjust</h3>
          <form id="adjust-form" class="row">
            <select id="adjust-scope">
              <option value="pool">Global pool</option>
              <option value="local">Local team (spend)</option>
            </select>
            <select id="adjust-pool-id" title="Global team"></select>
            <select id="adjust-local-id" title="Local team (auto relleno por pool)"></select>
            <input id="adjust-delta" type="number" step="1" value="1" />
            <input id="adjust-reason" placeholder="Reason (optional)" />
            <button type="submit" class="primary">Apply</button>
          </form>
          <div class="hint">Use negative values to subtract (spend) when needed.</div>
        </div>

        <!-- Gestión de equipos + membresías -->
        <div class="card">
          <h3 class="section-title">Teams management</h3>
          <div class="grid-2">
            <div>
              <form id="new-team-form" class="row">
                <input id="team-name" placeholder="Team name (e.g., Team 1)" required />
                <input id="team-class" placeholder="Class/Group (e.g., 8A)" />
                <button type="submit">Create team</button>
              </form>

              <div class="row" style="margin-top:8px">
                <select id="team-select" title="Team"></select>
                <button id="reload-teams" type="button">Reload</button>
                <button id="delete-team" type="button">Delete team</button>
              </div>

              <div class="row" style="margin-top:8px">
                <select id="student-pool" title="Student"></select>
                <button id="assign-member" type="button">Assign to team</button>
                <button id="remove-member" type="button">Remove from team</button>
              </div>

              <div style="margin-top:8px">
                <strong>Team members</strong>
                <ul id="team-members"></ul>
              </div>

              <div style="margin-top:8px">
                <strong>Team balance:</strong> <span id="team-balance">—</span> pts
              </div>
            </div>

            <!-- Link card -->
            <div>
              <h4 style="margin:0 0 8px">Link card</h4>
              <div class="row">
                <select id="link-card-role">
                  <option value="student">Student card</option>
                  <option value="team_earn">Team (global/local) earn card</option>
                </select>
                <input id="link-card-uid" placeholder="Scan or type UID" />
              </div>
              <div class="row" style="margin-top:8px">
                <select id="link-card-student" title="Student"></select>
                <select id="link-card-team" title="Team"></select>
                <button id="link-card-btn" class="primary">Save link</button>
              </div>
              <div class="hint">UIDs are normalized to uppercase HEX without separators automatically.</div>
            </div>
          </div>
        </div>

        <!-- Local leaderboard (por pool) -->
        <div class="card">
          <h3 class="section-title">Local leaderboard</h3>
          <div class="row">
            <select id="leaderboard-pool" title="Global team"></select>
            <button id="refresh-leaderboard" type="button">Reload</button>
          </div>
          <div class="scroll-300" style="margin-top:8px">
            <table id="leaderboard-table">
              <thead><tr><th>#</th><th>Local team</th><th>Spent</th><th>Total (local)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Ordenado por <em>Total (local) = pool − spent</em>, de mayor a menor.</div>
        </div>

        <!-- All locals leaderboard -->
        <div class="card">
          <h3 class="section-title">All locals leaderboard</h3>
          <div class="row">
            <label><input type="checkbox" id="alllb-filter-toggle" /> Filter by global</label>
            <select id="alllb-pool" title="Global team" disabled></select>
            <button id="alllb-refresh" type="button">Reload</button>
          </div>
          <div class="muted" id="alllb-legend" style="margin-top:8px"></div>
          <div class="scroll-300" style="margin-top:8px">
            <table id="alllb-table">
              <thead><tr><th>#</th><th>Local team</th><th>Global</th><th>Spent</th><th>Total (local)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Global table of all local teams. Shaded by pool color.</div>
        </div>

        <!-- ASCII games leaderboards -->
        <div class="card">
          <h3 class="section-title">ASCII games access</h3>
          <div class="row">
            <a href="./game.html" target="_blank" rel="noreferrer">
              <button type="button" class="primary">Open games</button>
            </a>
            <a href="https://lihuel-web.github.io/GameAlchemy/" target="_blank" rel="noreferrer">
              <button type="button">Play Alchemy</button>
            </a>
            <div class="hint">Open minigames in a new tab (read-only, no points spent).</div>
          </div>
        </div>

        <div class="card">
          <h3 class="section-title">ASCII games leaderboards</h3>
          <div class="row">
            <select id="ascii-game-select" title="Juego">
              <option>Loading…</option>
            </select>
            <button id="ascii-lb-refresh" type="button">Reload</button>
          </div>
          <div class="grid-2" style="margin-top:10px">
            <div>
              <h4 style="margin:0 0 6px">Top students (global)</h4>
              <div class="scroll-300">
                <table id="ascii-lb-students">
                  <thead><tr><th>#</th><th>Student</th><th>Local</th><th>Best</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div>
              <h4 style="margin:0 0 6px">Top local teams (global)</h4>
              <div class="scroll-300">
                <table id="ascii-lb-teams">
                  <thead><tr><th>#</th><th>Local team</th><th>Global</th><th>Player</th><th>Team best</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="hint">Live scores from the ASCII minigames (Flappy, Snake, Tetris, Road).</div>
        </div>

        <!-- STUDENTS MANAGEMENT -->
        <div id="students-mgmt" class="card">
          <h3 class="section-title">Students</h3>
          <div class="grid-2">
            <!-- Real (Auth) -->
            <div>
              <h4 style="margin:0 0 8px">Create real student (Auth)</h4>
              <form id="real-student-form" class="row">
                <input id="real-name" placeholder="Name (optional)" />
                <input id="real-class" placeholder="Class/Group" />
                <input id="real-email" type="email" placeholder="Email" required />
                <input id="real-pass" type="password" placeholder="Temp password (min 6)" required />
                <input id="real-card-uid" placeholder="Card UID (optional)" />
                <select id="real-pool-team" title="Global team (optional)"></select>
                <select id="real-local-team" title="Local team (optional)"></select>
                <button type="submit" class="primary">Create</button>
              </form>
              <div class="hint">You can pick the <strong>local</strong> first and the global is filled automatically.</div>
            </div>

            <!-- Record-only -->
            <div>
              <h4 style="margin:0 0 8px">Add record-only student</h4>
              <form id="fake-student-form" class="row">
                <input id="fake-name" placeholder="Name" required />
                <input id="fake-class" placeholder="Class/Group" />
                <input id="fake-card-uid" placeholder="Card UID (optional)" />
                <select id="fake-pool-team" title="Global team (optional)"></select>
                <select id="fake-local-team" title="Local team (optional)"></select>
                <button type="submit">Add</button>
              </form>
              <div class="hint">You can pick the <strong>local</strong> first and the global is filled automatically.</div>
            </div>
          </div>

          <!-- Danger zone: Delete student -->
          <div style="margin-top:12px">
            <h4 style="margin:0 0 8px">Delete student</h4>
            <div class="row">
              <select id="delete-student-select" title="Student to delete"></select>
              <button id="delete-student-btn" class="danger">Delete</button>
            </div>
            <div class="hint">Deletes the student, their Auth user (if any), and cleans memberships/tx (CASCADE/Edge).</div>
          </div>
        </div>

        <!-- ADMIN — Resets (colocar antes de </section> de #teacher-panel) -->
<div class="card">
  <h3 class="section-title">Admin — Resets</h3>
  <div class="row">
    <button id="btn-open-reset-points" class="danger">Reset points (earn/spend)</button>
    <button id="btn-open-reset-scores">Reset game scores</button>
  </div>
  <div class="hint">Everything is archived before deletion. Teachers only.</div>
</div>

<!-- Modal: Reset points -->
<div id="modal-reset-points" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
  <div style="max-width:560px; margin:8vh auto; background:#fff; color:#123; border:1px solid #e2e8f6; border-radius:12px; padding:16px;">
    <h3 class="section-title">Reset points (earn/spend)</h3>
    <p>This wipes <strong>all</strong> student and pool transactions, resetting points to 0 (with backup).</p>
    <label class="row" style="margin:8px 0;">
      <input type="checkbox" id="rp-include-scores" />
      <span>Also include <strong>game leaderboards</strong></span>
    </label>
    <p style="margin-top:10px;">Type <code>RESETEAR PUNTOS</code> to confirm:</p>
    <input id="rp-confirm" placeholder="RESETEAR PUNTOS" style="width:100%; padding:8px; margin-top:4px;" />
    <div class="row" style="margin-top:12px;">
      <button id="rp-exec" class="danger" disabled>Run points reset</button>
      <button id="rp-cancel">Cancel</button>
    </div>
    <pre id="rp-result" class="muted" style="margin-top:12px; white-space:pre-wrap;"></pre>
  </div>
</div>

<!-- Modal: Reset game scores -->
<div id="modal-reset-scores" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">
  <div style="max-width:560px; margin:8vh auto; background:#fff; color:#123; border:1px solid #e2e8f6; border-radius:12px; padding:16px;">
    <h3 class="section-title">Reset game scores</h3>
    <p>This <strong>does not</strong> touch team/student points; it just clears leaderboards after backing them up.</p>
    <fieldset style="margin:8px 0;">
      <legend>Games to reset</legend>
      <label class="row"><input type="checkbox" class="rgs-game" value="flappy" checked /> Flappy</label>
      <label class="row"><input type="checkbox" class="rgs-game" value="snake"  checked /> Snake</label>
      <label class="row"><input type="checkbox" class="rgs-game" value="tetris" checked /> Tetris</label>
      <label class="row"><input type="checkbox" class="rgs-game" value="road"   checked /> Road Fighter</label>
    </fieldset>
    <p>Escribe <code>RESETEAR PUNTUACIONES</code> para confirmar:</p>
    <input id="rgs-confirm" placeholder="RESETEAR PUNTUACIONES" style="width:100%; padding:8px; margin-top:4px;" />
    <div class="row" style="margin-top:12px;">
      <button id="rgs-exec" class="danger" disabled>Run score reset</button>
      <button id="rgs-cancel">Cancel</button>
    </div>
    <pre id="rgs-result" class="muted" style="margin-top:12px; white-space:pre-wrap;"></pre>
  </div>
</div>

      </section> <!-- /#teacher-panel -->

      <!-- STUDENT -->
      <section id="student-panel" class="card">
        <h3 class="section-title">My points</h3>
        <div id="student-info" class="muted"></div>
        <h4>My balance: <span id="balance">—</span> points</h4>

        <div style="margin-top:10px">
          <strong>My last movements</strong>
          <div class="scroll-300">
            <table id="mytx-table">
              <thead><tr><th>Date</th><th>Δ</th><th>Reason</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:16px">
          <h3 class="section-title">My team</h3>
          <div id="team-info" class="muted"></div>
          <h4>Team balance: <span id="my-team-balance">—</span> points</h4>
          <div class="scroll-300">
            <strong>Team members</strong>
            <ul id="my-team-members"></ul>
          </div>
        </div>

        <!-- Overview del Pool Global del alumno -->
        <div style="margin-top:16px">
          <h3 class="section-title">Global team (pool) overview</h3>
          <div class="muted" id="pool-meta">—</div>
          <div class="row">
            <div><strong>Pool total:</strong> <span id="pool-total">—</span> pts</div>
            <div style="margin-left:12px"><strong>Remaining (overall):</strong> <span id="pool-remaining-global">—</span> pts</div>
          </div>

          <div class="row" style="margin-top:8px">
            <div><strong>My local spent:</strong> <span id="my-local-spent">—</span> pts</div>
            <div style="margin-left:12px"><strong>My local total (remaining):</strong> <span id="my-local-remaining">—</span> pts</div>
          </div>

          <div class="scroll-300" style="margin-top:8px">
            <table>
              <thead><tr><th>Local team</th><th>Spent</th><th>Remaining for this local</th></tr></thead>
              <tbody id="pool-locals-tbody"></tbody>
            </table>
          </div>
          <div class="hint">The highlighted row is your local team.</div>
        </div>

        <!-- Global teams leaderboard (estudiante) -->
        <div style="margin-top:16px">
          <h3 class="section-title">Global teams leaderboard</h3>
          <div class="scroll-300">
            <table id="student-global-leaderboard">
              <thead><tr><th>#</th><th>Global team</th><th>Points</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Ranking by global pool points.</div>
        </div>

        <!-- NUEVO: Top 9 local teams (estudiante) -->
        <div style="margin-top:16px">
          <h3 class="section-title">Top 9 local teams</h3>
          <div class="scroll-300">
            <table id="student-local-top9">
              <thead><tr><th>#</th><th>Local team</th><th>Global</th><th>Spent</th><th>Total (local)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">Shows only the top 9 local teams by <em>Total (local) = pool − spent</em>.</div>
        </div>

         <!-- link al juego que usa puntos del equipo local sin gastarlos-->
<div style="margin-top:16px">
  <a href="./game.html">
    <button class="primary">Play team game</button>
  </a>
  <a href="https://lihuel-web.github.io/GameAlchemy/" target="_blank" rel="noreferrer">
    <button>Play Alchemy</button>
  </a>
  <div class="hint">The game uses your local team points. They are not spent.</div>
</div>

        
      </section>
    </section>
  </main>

  <!-- Config pública -->
  <script src="./config.js"></script>
  <script>
    window.SUPABASE_URL = window.__SUPABASE_CONFIG?.url || localStorage.getItem('SUPABASE_URL') || '';
    window.SUPABASE_ANON_KEY = window.__SUPABASE_CONFIG?.anonKey || localStorage.getItem('SUPABASE_ANON_KEY') || '';
  </script>
  <script type="module" src="./app.js"></script>
</body>
</html>
